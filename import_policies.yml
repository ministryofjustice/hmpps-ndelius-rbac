---

- name: Create workspace
  file:
    path: '{{ workspace }}/policies'
    state: directory

- name: Upload policies
  template:
    src: '{{ item }}.j2'
    dest: '{{ workspace }}/{{ item }}'
    mode: 0644
  with_items:
    - policies/password-policy.ldif

- name: Remove existing policies
  shell: 'ldapdelete -H ldapi:// -Y EXTERNAL -Q -M -r -c "ou=Policies,{{ ldap_config.base_root }}"'
  register: remove_policies
  failed_when: remove_policies.rc not in [0,32] # 32=NO_OBJECT (entry already doesn't exist so nothing to delete)

- name: Import policies
  shell: 'ldapadd -H ldapi:/// -Y EXTERNAL -Q -f {{ workspace }}/{{ item }}'
  with_items:
    - policies/password-policy.ldif
