---

- name: Uplift LDAP
  hosts: ldap
  become: yes
  tasks:
    - name: Run uplift
      run_once: yes
      block:
        - name: Set facts
          set_fact:
            workspace: '/root/uplift/{{ ldap_config.rbac_version }}'

        - name: Ensure LDAP service is running so we can take a backup
          service:
            name: slapd
            state: started

        - name: Backup the data to S3
          shell: backup_ldap

        - name: Hash the admin password
          no_log: true
          shell: 'slappasswd -h {SSHA} -s ${bind_password}'
          environment:
            bind_password: "{{ lookup('aws_ssm', ssm_prefix+'ldap_admin_password', region=region) }}"
          register: bind_password_hash

        - name: Upload context LDIF
          template:
            src: context.ldif.j2
            dest: '{{ workspace }}/context.ldif'

        - name: Create base entries
          shell: 'ldapadd -Y EXTERNAL -H ldapi:/// -c -f {{ workspace }}/context.ldif'
          register: create_context
          failed_when: create_context.rc not in [0,68] # 68=ENTRY_EXISTS (duplicate entries should be ignored)

        - name: Import schemas
          include: import_schemas.yml

        - name: Import roles
          include: import_roles.yml

        - name: Import users/clients
          include: import_users.yml

        - name: Remove workspace
          file:
            path: '{{ workspace }}'
            state: absent