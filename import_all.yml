---

- name: Set facts
  set_fact:
    workspace: '/root/uplift/{{ ldap_config.rbac_version }}'
    ssm_prefix: '/{{ environment_name }}/{{ project_name }}/apacheds/apacheds/'

- name: Ensure LDAP service is running
  service:
    name: slapd
    state: started

- name: Check primary
  uri:
    url: http://localhost/is-primary
  register: check_primary
  failed_when: false

- name: Create context entries
  when: check_primary.status == 200
  include_tasks: create_context.yml

- name: Import policies
  when: check_primary.status == 200
  include_tasks: import_policies.yml

- name: Import schemas
  include_tasks: import_schemas.yml

- name: Import roles
  when: check_primary.status == 200
  include_tasks: import_roles.yml

- name: Import groups
  when: check_primary.status == 200
  include_tasks: import_groups.yml

- name: Import users/clients
  when: check_primary.status == 200
  include_tasks: import_users.yml

- name: Remove workspace
  file:
    path: '{{ workspace }}'
    state: absent